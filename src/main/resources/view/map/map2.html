<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <script th:replace="common/head::static"></script>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>路线规划</title>
    <link th:href="@{/sys/authority/css/authority.css}" rel="stylesheet" type="text/css"/>
<!--本系统路线规划的界面-->
    <style type="text/css">
        body,
        html {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "微软雅黑";
        }
        #map1_container,
        #map2_container {
            float: left;
            overflow: hidden;
            width: 48%;
            height: 100%;
            margin: 20px 12px;
        }
        #allmap1 {
            height: 100%;
            margin: 0 0 3px;
        }
        #allmap2 {
            height: 100%;
            margin: 3px 0 0;
        }
        .text1{
            text-align: center;
            margin: 10px;
        }
        .layui-input{
            width: 152px;
        }
        .layui-form-item{
            margin-left: -60px;
        }
        #output1{
            padding-top: 7px;
            color: seagreen;
            font-weight: bolder;
        }
        #output2{
            padding-top: 7px;
            color: seagreen;
            font-weight: bolder;
        }
        .layui-form-label{
            width: 244px !important;
        }
    </style>

</head>

<body>

<div id="map1_container">
    <div class="text1">
        <div class="layui-form-item">
            <label class="layui-form-label">上午路线规划</label>
            <div class="layui-input-block">
                <select name="hid" id="selectHouse1" class="layui-input" >
                </select>
                <a class="layui-btn" onclick="planRoute1()">规划</a>
            </div>
            <div id="output1"></div>
        </div>

    </div>
    <div id="allmap1"></div>
</div>
<div id="map2_container">
    <div class="text1">

        <div class="layui-form-item">
            <label class="layui-form-label">下午路线规划</label>
            <div class="layui-input-block">
                <select name="hid" id="selectHouse2" class="layui-input" >
                </select>
                <a class="layui-btn" onclick="planRoute2()">规划</a>

            </div>
            <div id="output2"></div>
        </div>
    </div>
    <div id="allmap2"></div>

</div>

<div id="allmap3" style="display: none"></div>


<script type="text/javascript"
        src="//api.map.baidu.com/api?v=2.0&ak=qgrzCLiUA9YOoqVU7WBvGBOPFTop21Gc">
</script>
<script>

    //百度地图将点连成路径
    function showPoly(pointList,map){

        //循环显示点对象
        for(let c=0;c<pointList.length;c++){
            let marker = new BMap.Marker(pointList[c]);
            map.addOverlay(marker);
            //将途经点按顺序添加到地图上
            let label = new BMap.Label(c+1,{offset:new BMap.Size(20,-10)});
            marker.setLabel(label);
        }

        let  group = Math.floor( pointList.length /11 ) ;
        let mode = pointList.length %11 ;

        let driving = new BMap.DrivingRoute( map, {onSearchComplete: function(results){
                if (driving.getStatus() == BMAP_STATUS_SUCCESS){
                    let plan = driving.getResults().getPlan(0);
                    let  num = plan.getNumRoutes();
                    // alert("plan.num ："+num);
                    for(let j =0;j<num ;j++){
                        let pts= plan.getRoute(j).getPath();    //通过驾车实例，获得一系列点的数组
                        let polyline = new BMap.Polyline(pts);
                        map.addOverlay(polyline);
                    }
                }
            }});
        for(var i =0;i<group;i++){
            var waypoints = pointList.slice(i*11+1,(i+1)*11);
            //注意这里的终点如果是11的倍数的时候，数组可是取不到最后一位的，所以要注意终点-1喔。感谢song141的提醒，怪我太粗心大意了~
            driving.search(pointList[i*11], pointList[(i+1)*11-1],{waypoints:waypoints});//waypoints表示途经点
        }
        if( mode != 0){
            var waypoints = pointList.slice(group*11,pointList.length-1);//多出的一段单独进行search
            driving.search(pointList[group*11],pointList[pointList.length-1],{waypoints:waypoints});
        }

    }



    //退火算法函数部分
    function buildDistsArrays(xCoors, yCoors){
        let maxDist = -1;
        let distance = new Array(xCoors.length);
        for(let i=0;i<xCoors.length;i++){        //一维长度
            distance[i] = new Array(xCoors.length);
            for(let j=0;j<xCoors.length;j++){    //二维长度
                distance[i][j] = 1000000;
            }
        }
        for (let i = 0; i < xCoors.length; i++){
            distance[i][i] = 0;// 对角线为0
            for (let j = i + 1; j < xCoors.length; j++){
                distance[i][j] = EUC_2D_dist(xCoors[i], xCoors[j], yCoors[i], yCoors[j]);
                distance[j][i] = distance[i][j];
                if (distance[i][j] > maxDist) {
                    maxDist = distance[i][j];
                }
            }
        }
        return distance;
    }


    function cost(rout,distance) {//计算该点序列的路径总长度
        let sum = 0;
        for (let i = 0; i < rout.length-1; i++) {
            sum += distance[ rout[i] ][ rout[i+1] ];
        }
        return sum;
    }

    function copyRout( rout) {//复制路经
        let out = new Array(rout.length);
        for (let i = 0; i < rout.length; i++)
            out[i] = rout[i];
        return out;
    }

    /**
     * 实现交叉互换，随机出两个不相同随机数，然后交换那两个位置的点
     * @param rout
     * @return 输出经过交换的新路径
     */
    function swap(rout) {
        let x,y;
        x=rout.length - 1;
        y=1;
        let r1 = parseInt(Math.random() * (x - y + 1) + y);//生成随机数0 ~ rout.length-1
        let r2 = parseInt(Math.random() * (x - y + 1) + y);
        while (r1===r2) {
            r2 = parseInt(Math.random() * (x - y + 1) + y);//两个随机数不能相同
        }
        let change = copyRout(rout);
        let tmp = change[r1];
        change[r1] = change[r2];
        change[r2] = tmp;
        return change;//输出交换任意两点后的点序列
    }

    function BFS(xCoors,distance) {
        //初始队列放入0，vis[0]=1
        let q = [];
        q.push(0);

        let vis = new Array(xCoors.length);//已被访问结点数组，访问=1，未访问=0
        for(let i = 0; i < xCoors.length; i++){
            vis[i] = 0;
        }
        let out = new Array(xCoors.length);//排好序后的节点数组
        out[0] = 0;
        vis[0] = 1;//第一个点标记为已访问
        let totalDist = 0;//现已加入的点的总距离
        let index = 1;//第2个节点的索引号
        while (q.length !== 0) {
            //只有还有未被访问的结点，则继续循环，直至所有节点都被访问过
            let front = q.pop();//获取首结点，并删除该节点
            let min = 100000;//min为两点间最短距离，Integer.MAX_VALUE：int数据类型的最大值
            let sIdx = 0;
            //获取队列的首结点font，找到与该节点距离最近的点i（该点未被访问，即vis[i]==0，且不是自己，即i!=font）
            for (let i = 0; i < xCoors.length; i++) {
                if (vis[i] === 0 && i !== front && min > distance[front][i]) {
                    min = distance[front][i];//两点最短距离
                    sIdx = i;//记录距离最短点的坐标
                }
            }
            if (min !== 100000) {
                vis[sIdx] = 1;//将距离最近的点标记为已访问
                q.push(sIdx);//将该点加入队列
                out[index] = sIdx;//将该点加入排好序后的数组，index=1起
                index++;
                totalDist += distance[front][sIdx];//现已加入的点的总距离
            }
        }
        q = null;//队列赋值为空

        return out;//返回排好序的节点坐标
    }
    /**
     * 模拟退火算法SA
     * @param rout	输入用于迭代的路径
     * @param T0	初始温度
     * @param d	温度衰减率，0.98
     * @param Tk	最低温度
     * @param L		内循环次数
     * @return	输出得到的最优路径
     */
    function Sa_TSP(rout,distance, T0, d, Tk, L) {
        let bestpath, curentpath;//最佳、当前路经
        let t = T0;//当前温度=初始温度
        bestpath = curentpath = copyRout(rout);
        while (t > Tk) {//当前温度>最低温度
            let it=0;//内循环次数初值为0
            while (it<L) {
                let update_path = swap(curentpath);//更新路经
                let delta = cost(update_path, distance) - cost(curentpath, distance);
                //计算更新后的路经结果成本与更新前（当前）路经结果成本的差值
                if (delta < 0) {//为负值，即结果成本降低了，则接受
                    curentpath = update_path;
                    bestpath = update_path;
                } else {
                    //若为正值，则以一定的概率接收
                    let p = Math.exp(-delta/t);//接收概率（取决于当前温度和两次路经结果的差值）
                    if (Math.random() <= p) {
                        //random.nextDouble()：生成一个大于等于0.0小于1.0的浮点数
                        //若接收概率大于生成的随机数，则接收更新后的路径
                        curentpath = update_path;
                    }
                }
                it++;
            }
            t *=d;
        }
        return bestpath;
    }

    function print(rout,distance) {
        console.log("总长度：" + cost(rout,distance));
        console.log("总路线：" + rout[0]);
        for (let i = 1; i < rout.length; i++) {
            console.log("->" + rout[i]);
        }
    }

    //输入排好序的点序列，点的名称，点的描述，订单数量，横纵坐标，输出排好序的点对象数组（名称，描述，横坐标，纵坐标）
    function printPoint(rout, nameRout,desRout,orderNum, xRout, yRout){
        let points = [];
        for (let i = 0 ; i < rout.length; i++){
            let point = {};
            point.orderNum = orderNum[rout[i]];
            point.description = desRout[rout[i]];
            point.name = nameRout[rout[i]];
            point.x = xRout[rout[i]];
            point.y = yRout[rout[i]];
            points.push(point);
        }
        return points;
    }

    function EUC_2D_dist( x1, x2, y1, y2) {
        return  Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));
    }

    //去重复元素（输出标记nameRout,重复1，不重复0）
    //3个数组，点的名字（地点名），横坐标，纵坐标
    function eliminateDuplicate(nameRout, xRout, yRout){
        let nameRout1 = [];//记录重复元素
        for (let i = 0; i < nameRout.length;i++){
            nameRout1[i] = 0;
        }
        for (let i = 1; i < nameRout.length; i++){
            for (let j=0 ;j < i;j++){
                if(nameRout[i] === nameRout[j] && xRout[i] === xRout[j] && yRout[i] === yRout[j]){
                    nameRout1[i] = 1;//有重复，记为1
                }
            }
        }
        return nameRout1;
    }

    //去重复元素（输出标记idRout,重复1，不重复0）
    //输出点的id标记
    function eliminateDuplicate1(idRout){
        let idRout1 = [];//记录重复元素
        for (let i = 0; i < idRout.length;i++){
            idRout1[i] = 0;
        }
        for (let i = 1; i < idRout.length; i++){
            for (let j=0 ;j < i;j++){
                if(idRout[i] === idRout[j]){
                    idRout1[i] = 1;//有重复，记为1
                }
            }
        }
        return idRout1;
    }

    //nameRout1:标记重复的数组，1重复，0不重复
    //rout：原始数组
    //输出去重后的rout
    function changeArray(nameRout1, rout){
        let changeRout = [];
        for (let i = 0;i < nameRout1.length; i++){
            if(nameRout1[i] === 0){
                changeRout.push(rout[i]);
            }
        }
        return changeRout;
    }
    //退火算法函数部分结束

    let p111 = new BMap.Point(116.301934,39.977552);
    let p222 = new BMap.Point(116.508328,39.919141);
    let p333 = new BMap.Point(116.365942,39.996165);
    let p444 = new BMap.Point(116.408757,39.995704);

    $.post(ctx + "/info/infohouse/list", {}, function (data) {
        if(data.flag){
            $('#selectHouse1').empty();
            for(let i = 0 ; i < data.data.length ; i ++){
                $('#selectHouse1').append(' <option value="'+data.data[i].hid+'">'+data.data[i].hname+'</option>');
            }
            $('#selectHouse2').empty();
            for(let i = 0 ; i < data.data.length ; i ++){
                $('#selectHouse2').append(' <option value="'+data.data[i].hid+'">'+data.data[i].hname+'</option>');
            }
        }
    });


    //隐藏地图
    let map3 = new BMap.Map("allmap3");
    map3.centerAndZoom(new BMap.Point(126.692, 45.699), 11);
    map3.enableScrollWheelZoom(true);


    function planRoute0(){
        $.post(ctx + "/sys/sysUser/getUser", {loginName:window.parent.loginName}, function (data) {
            //debugger
            if(data.flag){
                console.log(data);
                // debugger
                $.post(ctx + "/order/order22/list", {
                    companyId:data.data.companyId,
                    gotime:getNowFormatDate(),
                    gotimes:'08:30-11:30'
                }, function (data1) {
                    if(data1.flag){

                        console.log("data1.data------------");
                        console.log(data1.data);
                        console.log("data1.data------------");

                        let idPoints = [];
                        let namePoints = [];
                        let xCoord = [];
                        let yCoord = [];
                        for (let i = 1; i < data1.data.length + 1;i++){
                            idPoints[i] = data1.data[i-1].hid;//点id
                            namePoints[i] = data1.data[i-1].hname;//点名称
                            xCoord[i] = Number(data1.data[i-1].lat);//纬度
                            yCoord[i] = Number(data1.data[i-1].lng);//经度
                        }
                        let selectHouse11= $("#selectHouse1").val();
                        // $.post(ctx + "/info/infohouse/list", {
                        $.post(ctx + "/info/infohouse/list", {
                            hid:selectHouse11,
                        }, function (data3) {
                            if(data3.flag){
                                // console.log(selectHouse11);
                                console.log(data3);
                                console.log("+++++++++++++++++++++++++++++++");
                                console.log(Number(data3.data[0].lng));//经度
                                console.log(Number(data3.data[0].lat));//纬度
                                console.log(data3.data[0].hname);//地点名称
                                console.log("+++++++++++++++++++++++++++++++");
                                console.log(idPoints);
                                // debugger
                                //初始数组
                                idPoints[0] = data3.data[0].hid;
                                namePoints[0] = data3.data[0].hname;
                                xCoord[0] = Number(data3.data[0].lat);//纬度
                                yCoord[0] = Number(data3.data[0].lng);//经度
                                // debugger
                                //去重，得到新的不重复数组
                                // let flagPoints = eliminateDuplicate(namePoints, xCoord, yCoord);//记录重复数组
                                let flagPoints = eliminateDuplicate1(idPoints);//记录重复数组
                                //去重后的数组
                                let idPoints1 = changeArray(flagPoints, idPoints);
                                let namePoints1 = changeArray(flagPoints, namePoints);
                                let xCoord1 = changeArray(flagPoints, xCoord);
                                let yCoord1 = changeArray(flagPoints, yCoord);
                                console.log(idPoints1);
                                console.log(namePoints1);
                                console.log(xCoord1);
                                console.log(yCoord1);
                                console.log(namePoints1.length);
                                console.log("-------------去重后");
                                // debugger
                                //定义起点，终点，途经点
                                let startPoint1 = [];
                                let endPoint1 = [];
                                let pathPoints1 = [];
                                // 百度地图API功能
                                let map1 = new BMap.Map("allmap1");
                                map1.centerAndZoom(new BMap.Point(126.692, 45.699), 11);
                                map1.enableScrollWheelZoom(true);
                                if(namePoints1.length > 2){
                                    let distanceList = buildDistsArrays(xCoord1, yCoord1);
                                    let rout = BFS(xCoord1,distanceList);//排好序的点下标（贪心）
                                    let T0=1e6;
                                    let d=0.99;
                                    let Tk=1e-6;
                                    let L = 20*rout.length;//内循环次数
                                    let rout2 = Sa_TSP(rout, distanceList, T0, d, Tk, L);
                                    print(rout2, distanceList);
                                    let points = printPoint(rout2, namePoints1, xCoord1, yCoord1);
                                    console.log("排好序后的点对象数组：");
                                    console.log(points);
                                    //定义排好序后的点序列
                                    let pointlist = [];  //排好序后的地点序列(x,y)
                                    for(let i = 0; i < points.length; i++){
                                        pointlist[i] = new BMap.Point(points[i].y,points[i].x);
                                    }



                                    //起点
                                    let mp1 = pointlist[0];
                                    //终点
                                    let mp2 = pointlist[pointlist.length-1];

                                    map1.clearOverlays();
                                    //创建行车路线规划实例
                                    let driving = new BMap.DrivingRoute(map1);
                                    for(let i = 0;i<pointlist.length;i++){
                                        if(i != pointlist.length-1){
                                            driving.search(pointlist[i], pointlist[i+1]);  //绘制两个点之间的路线
                                        }
                                    }

                                    for (let i = 1;i<pointlist.length-1;i++){
                                        let mark = new BMap.Marker(pointlist[i]);
                                        map1.addOverlay(mark);



                                        let label = new BMap.Label(i.toString(),{position:pointlist[i]});
                                        map1.addOverlay(label);
                                    }

                                    //显示终点和起点的标注
                                    driving.setSearchCompleteCallback(function(){
                                        let pts = driving.getResults().getPlan(0).getRoute(0).getPath();
                                        //通过驾车实例，获得一系列点的数组
                                        let polyline = new BMap.Polyline(pts);
                                        map1.addOverlay(polyline);
                                        let m1 = new BMap.Marker(mp1);         //起点
                                        let m2 = new BMap.Marker(mp2);        //终点
                                        map1.addOverlay(m1);
                                        map1.addOverlay(m2);
                                        let lab1 = new BMap.Label("起点",{position:mp1});
                                        let lab2 = new BMap.Label("终点",{position:mp2});
                                        map1.addOverlay(lab1);
                                        map1.addOverlay(lab2);
                                        setTimeout(function(){
                                            map1.setViewport(pointlist);
                                            //调整到最佳视野
                                        },1000);
                                    });




                                }
                                else if(namePoints1.length === 2){
                                    let startPoint1 = [];
                                    let endPoint1 = [];
                                    startPoint1[0] = yCoord1[0];
                                    startPoint1[1] = xCoord1[0];
                                    endPoint1[0] = yCoord1[1];
                                    endPoint1[1] = xCoord1[1];
                                    let p1 = new BMap.Point(startPoint1[0],startPoint1[1]);//起点
                                    let p2 = new BMap.Point(endPoint1[0],endPoint1[1]);//终点
                                    let driving1 = new BMap.DrivingRoute(map1,
                                        {renderOptions:{map: map1, autoViewport: true}});
                                    driving1.search(p1, p2);//waypoints表示途经点
                                }
                            }
                        });
                    }
                });
            }
        });
    }


    function planRoute1(){
        $.post(ctx + "/sys/sysUser/getUser", {loginName:window.parent.loginName}, function (data) {
            //debugger
            if(data.flag){
                console.log(data);
                // debugger
                $.post(ctx + "/order/order22/list", {
                    companyId:data.data.companyId,
                    gotime:getNowFormatDate(),
                    gotimes:'08:30-11:30',
                }, function (data1) {
                    if(data1.flag){

                        console.log("data1.data------------初始无序的点");
                        console.log(data1.data);
                        console.log("data1.data------------初始无序的点");

                        let idPoints = [];  //小区id
                        let namePoints = [];//小区名称
                        let descriptionPoints = []; //小区描述
                        let xCoord = [];  //小区横坐标
                        let yCoord = [];  //小区纵坐标
                        for (let i = 1; i < data1.data.length + 1;i++){
                            idPoints[i] = data1.data[i-1].hid;//点id
                            namePoints[i] = data1.data[i-1].hname;//点名称
                            descriptionPoints[i] = data1.data[i-1].hdescription;//小区描述
                            xCoord[i] = Number(data1.data[i-1].lat);//纬度
                            yCoord[i] = Number(data1.data[i-1].lng);//经度
                        }
                        let selectHouse11= $("#selectHouse1").val();
                        // $.post(ctx + "/info/infohouse/list", {
                        $.post(ctx + "/info/infohouse/list", {
                            hid:selectHouse11,
                        }, function (data3) {
                            if(data3.flag){
                                // console.log(selectHouse11);
                                console.log(data3);
                                console.log("+++++++++++++++++++++++++++++++");
                                console.log(data3.data[0].hdescription);//地点描述
                                console.log(Number(data3.data[0].lng));//经度
                                console.log(Number(data3.data[0].lat));//纬度
                                console.log(data3.data[0].hname);//地点名称
                                console.log("+++++++++++++++++++++++++++++++");
                                console.log(idPoints);
                                // debugger
                                //初始数组
                                idPoints[0] = data3.data[0].hid;//小区id
                                namePoints[0] = data3.data[0].hname;//小区名称
                                descriptionPoints[0] = data3.data[0].hdescription;//小区描述
                                xCoord[0] = Number(data3.data[0].lat);//纬度
                                yCoord[0] = Number(data3.data[0].lng);//经度
                                // debugger
                                //去重，得到新的不重复数组
                                // let flagPoints = eliminateDuplicate(namePoints, xCoord, yCoord);//记录重复数组
                                let flagPoints = eliminateDuplicate1(idPoints);//记录重复数组
                                //去重后的数组
                                let idPoints1 = changeArray(flagPoints, idPoints);
                                let namePoints1 = changeArray(flagPoints, namePoints);
                                let descriptionPoints1 = changeArray(flagPoints, descriptionPoints);
                                let xCoord1 = changeArray(flagPoints, xCoord);
                                let yCoord1 = changeArray(flagPoints, yCoord);
                                let orderNumber1 = [];//订单数量
                                for (let i= 0;i<idPoints1.length;i++){
                                    orderNumber1[i] = 0;
                                }
                                console.log("-------------去重后");
                                console.log(idPoints1);
                                console.log(namePoints1);
                                console.log(descriptionPoints1);
                                console.log(xCoord1);
                                console.log(yCoord1);
                                console.log(namePoints1.length);
                                console.log("-------------去重后");
                                console.log("=======================================重复订单次数")
                                for (let i = 0; i<idPoints1.length;i++){
                                    for (let j = 0;j<idPoints.length;j++){
                                        if(idPoints1[i] === idPoints[j]){
                                            orderNumber1[i]++;
                                        }
                                    }
                                }
                                if(orderNumber1[0] > 0){
                                    orderNumber1[0]--;
                                }
                                console.log(orderNumber1.length);
                                console.log(orderNumber1);
                                console.log("=======================================重复订单次数")
                                // debugger
                                //定义起点，终点，途经点
                                let startPoint1 = [];
                                let endPoint1 = [];
                                let pathPoints1 = [];
                                // 百度地图API功能
                                let map1 = new BMap.Map("allmap1");
                                map1.centerAndZoom(new BMap.Point(126.692, 45.699), 11);
                                map1.enableScrollWheelZoom(true);
                                if(namePoints1.length > 2){
                                    let distanceList = buildDistsArrays(xCoord1, yCoord1);
                                    let rout = BFS(xCoord1,distanceList);//排好序的点下标（贪心）
                                    let T0=1e6;
                                    let d=0.99;
                                    let Tk=1e-6;
                                    let L = 20*rout.length;//内循环次数
                                    let rout2 = Sa_TSP(rout, distanceList, T0, d, Tk, L);
                                    print(rout2, distanceList);
                                    let points = printPoint(rout2, namePoints1,descriptionPoints1,orderNumber1, xCoord1, yCoord1);
                                    console.log("排好序后的点对象数组：");
                                    console.log(points);
                                    //定义排好序后的点序列
                                    let pointlist = [];
                                    for(let i = 0; i < points.length; i++){
                                        pointlist[i] = new BMap.Point(points[i].y,points[i].x);
                                    }


                                    //起点
                                    let mp1 = pointlist[0];
                                    //终点
                                    let mp2 = pointlist[pointlist.length-1];

                                    map1.clearOverlays();                        //清除地图上所有的覆盖物


                                    //创建行车路线规划实例
                                    let driving = new BMap.DrivingRoute(map1);
                                    for(let i = 0;i<pointlist.length;i++){
                                        if(i != pointlist.length-1){
                                            driving.search(pointlist[i], pointlist[i+1]);  //绘制两个点之间的路线
                                        }
                                    }

                                    //标记点信息:标记点，当前点，下一个点，当前点名称，下一点名称，点信息窗口标题，点详细信息，地图
                                    function markInfo(mark,points1,points2,pointsname1,pointsname2,pointInfoTitle,pointText,map){
                                        mark.addEventListener("click",function(e){
                                            let opts = {
                                                width: 250,  // 信息窗口宽度
                                                height: 100,  // 信息窗口高度
                                                title: pointInfoTitle, // 信息窗口标题
                                            }
                                            //创建信息窗口对象
                                            let infoWindow = new BMap.InfoWindow(pointText, opts);
                                            //对标注对象和信息窗口进行绑定
                                            map.openInfoWindow(infoWindow, points1);
                                            getduration(points1,points2,map3,pointsname1,pointsname2);

                                        });
                                    }

                                    //标记点信息:标记点，当前点，点信息窗口标题，点详细信息，地图（终点）
                                    function markInfoEnd(mark,points1,pointInfoTitle,pointText,map){
                                        mark.addEventListener("click",function(e){
                                            var opts = {
                                                width: 250,  // 信息窗口宽度
                                                height: 100,  // 信息窗口高度
                                                title: pointInfoTitle, // 信息窗口标题
                                            }
                                            //创建信息窗口对象
                                            var infoWindow = new BMap.InfoWindow(pointText, opts);
                                            //对标注对象和信息窗口进行绑定
                                            map.openInfoWindow(infoWindow, points1);
                                            G("output1").innerHTML = "终点";
                                        });
                                    }


                                    function G(id) {
                                        return document.getElementById(id);
                                    }

                                    //返回两点实际距离，时间
                                    //参数：第一点，第二点，渲染地图，第一点的名称，第二点的名称
                                    function getduration(point1, point2,map,pointname1,pointname2) {
                                        //var startdm = G("suggestId").innerHTML;
                                        //var enddm = G("suggestId2").innerHTML;
                                        var output = pointname1 + "->" + pointname2 + " ：驾车需要";
                                        var searchComplete = function (results) {
                                            if (transit.getStatus() != BMAP_STATUS_SUCCESS) {
                                                return;
                                            }
                                            var plan = results.getPlan(0);
                                            output += plan.getDuration(true) + "\n";                //获取时间
                                            output += "，路程为";
                                            output += plan.getDistance(true) + "\n";             //获取距离
                                            G("output1").innerHTML = output;
                                        }
                                        let transit = new BMap.DrivingRoute(map, {
                                            renderOptions: { map: map },
                                            onSearchComplete: searchComplete,
                                            onPolylinesSet: function () {
                                                // setTimeout(function () { alert(output) }, "1000");
                                            }
                                        });
                                        transit.search(point1, point2);
                                    }





                                    //除去起点和终点后的所有途经点
                                    for (let i = 1;i<pointlist.length-1;i++){
                                        let mark = new BMap.Marker(pointlist[i]);
                                        map1.addOverlay(mark);

                                        //pop信息标题
                                        let title1 =  '<div style="font-weight:bold;color:#CE5521;font-size:20px">' + "订单数：" + points[i].orderNum + "个" + '</div>';
                                        //pop弹窗信息
                                        let html1 =  '<div style="font-size:17px">' + points[i].name +'<br>描述：'+ points[i].description + '</div>';

                                        markInfo(mark,pointlist[i],pointlist[i+1],points[i].name,points[i+1].name,title1,html1,map1);


                                        let label = new BMap.Label(i.toString(),{position:pointlist[i]});
                                        map1.addOverlay(label);
                                    }

                                    //显示终点和起点的标注
                                    driving.setSearchCompleteCallback(function(){
                                        let pts = driving.getResults().getPlan(0).getRoute(0).getPath();
                                        //通过驾车实例，获得一系列点的数组
                                        let polyline = new BMap.Polyline(pts);
                                        map1.addOverlay(polyline);
                                        let m1 = new BMap.Marker(mp1);         //起点
                                        let m2 = new BMap.Marker(mp2);         //终点
                                        map1.addOverlay(m1);
                                        map1.addOverlay(m2);


                                        //pop信息标题
                                        let title2m1 =  '<div style="font-weight:bold;color:#CE5521;font-size:20px">' + "订单数：" + points[0].orderNum + "个" + '</div>';
                                        let title2m2 =  '<div style="font-weight:bold;color:#CE5521;font-size:20px">' + "订单数：" + points[points.length-1].orderNum + "个" + '</div>';

                                        //pop弹窗信息
                                        let html2m1 =  '<div style="font-size:17px">' + points[0].name + '<br>描述'+ points[0].description + '</div>';
                                        let html2m2 =  '<div style="font-size:17px">' + points[points.length-1].name + '<br>描述：' + points[points.length-1].description + '</div>';


                                        markInfo(m1,mp1,pointlist[1],points[0].name,points[1].name,title2m1,html2m1,map1);//起点标记
                                        markInfoEnd(m2,mp2,title2m2,html2m2,map1);//终点标记


                                        let lab1 = new BMap.Label("起点",{position:mp1});
                                        let lab2 = new BMap.Label("终点",{position:mp2});
                                        map1.addOverlay(lab1);
                                        map1.addOverlay(lab2);
                                        setTimeout(function(){
                                            map1.setViewport(pointlist);
                                            //调整到最佳视野
                                        },1000);
                                    });


                                }
                                else if(namePoints1.length === 2){
                                    let startPoint1 = [];
                                    let endPoint1 = [];
                                    startPoint1[0] = yCoord1[0];
                                    startPoint1[1] = xCoord1[0];
                                    endPoint1[0] = yCoord1[1];
                                    endPoint1[1] = xCoord1[1];
                                    let p1 = new BMap.Point(startPoint1[0],startPoint1[1]);//起点
                                    let p2 = new BMap.Point(endPoint1[0],endPoint1[1]);//终点
                                    let driving2 = new BMap.DrivingRoute(map1,
                                        {renderOptions:{map: map1, autoViewport: true}});
                                    driving2.search(p1, p2);//waypoints表示途经点
                                }
                            }
                        });
                    }
                });
            }
        });
    }



    function planRoute2(){
        $.post(ctx + "/sys/sysUser/getUser", {loginName:window.parent.loginName}, function (data) {
            //debugger
            if(data.flag){
                console.log(data);
                // debugger
                $.post(ctx + "/order/order22/list", {
                    companyId:data.data.companyId,
                    gotime:getNowFormatDate(),
                    gotimes:'14:30-18:30',
                }, function (data1) {
                    if(data1.flag){

                        console.log("data1.data------------初始无序的点");
                        console.log(data1.data);
                        console.log("data1.data------------初始无序的点");

                        let idPoints = [];  //小区id
                        let namePoints = [];//小区名称
                        let descriptionPoints = []; //小区描述
                        let xCoord = [];  //小区横坐标
                        let yCoord = [];  //小区纵坐标
                        for (let i = 1; i < data1.data.length + 1;i++){
                            idPoints[i] = data1.data[i-1].hid;//点id
                            namePoints[i] = data1.data[i-1].hname;//点名称
                            descriptionPoints[i] = data1.data[i-1].hdescription;//小区描述
                            xCoord[i] = Number(data1.data[i-1].lat);//纬度
                            yCoord[i] = Number(data1.data[i-1].lng);//经度
                        }
                        let selectHouse11= $("#selectHouse2").val();
                        // $.post(ctx + "/info/infohouse/list", {
                        $.post(ctx + "/info/infohouse/list", {
                            hid:selectHouse11,
                        }, function (data3) {
                            if(data3.flag){
                                // console.log(selectHouse11);
                                console.log(data3);
                                console.log("+++++++++++++++++++++++++++++++");
                                console.log(data3.data[0].hdescription);//地点描述
                                console.log(Number(data3.data[0].lng));//经度
                                console.log(Number(data3.data[0].lat));//纬度
                                console.log(data3.data[0].hname);//地点名称
                                console.log("+++++++++++++++++++++++++++++++");
                                console.log(idPoints);
                                // debugger
                                //初始数组
                                idPoints[0] = data3.data[0].hid;//小区id
                                namePoints[0] = data3.data[0].hname;//小区名称
                                descriptionPoints[0] = data3.data[0].hdescription;//小区描述
                                xCoord[0] = Number(data3.data[0].lat);//纬度
                                yCoord[0] = Number(data3.data[0].lng);//经度
                                // debugger
                                //去重，得到新的不重复数组
                                // let flagPoints = eliminateDuplicate(namePoints, xCoord, yCoord);//记录重复数组
                                let flagPoints = eliminateDuplicate1(idPoints);//记录重复数组
                                //去重后的数组
                                let idPoints1 = changeArray(flagPoints, idPoints);
                                let namePoints1 = changeArray(flagPoints, namePoints);
                                let descriptionPoints1 = changeArray(flagPoints, descriptionPoints);
                                let xCoord1 = changeArray(flagPoints, xCoord);
                                let yCoord1 = changeArray(flagPoints, yCoord);
                                let orderNumber1 = [];//订单数量
                                for (let i= 0;i<idPoints1.length;i++){
                                    orderNumber1[i] = 0;
                                }
                                console.log("-------------去重后");
                                console.log(idPoints1);
                                console.log(namePoints1);
                                console.log(descriptionPoints1);
                                console.log(xCoord1);
                                console.log(yCoord1);
                                console.log(namePoints1.length);
                                console.log("-------------去重后");
                                console.log("=======================================重复订单次数")
                                for (let i = 0; i<idPoints1.length;i++){
                                    for (let j = 0;j<idPoints.length;j++){
                                        if(idPoints1[i] === idPoints[j]){
                                            orderNumber1[i]++;
                                        }
                                    }
                                }
                                if(orderNumber1[0] > 0){
                                    orderNumber1[0]--;
                                }
                                console.log(orderNumber1.length);
                                console.log(orderNumber1);
                                console.log("=======================================重复订单次数")
                                // debugger
                                //定义起点，终点，途经点
                                let startPoint1 = [];
                                let endPoint1 = [];
                                let pathPoints1 = [];
                                // 百度地图API功能
                                let map2 = new BMap.Map("allmap2");
                                map2.centerAndZoom(new BMap.Point(126.692, 45.699), 11);
                                map2.enableScrollWheelZoom(true);
                                if(namePoints1.length > 2){
                                    let distanceList = buildDistsArrays(xCoord1, yCoord1);
                                    let rout = BFS(xCoord1,distanceList);//排好序的点下标（贪心）
                                    let T0=1e6;
                                    let d=0.99;
                                    let Tk=1e-6;
                                    let L = 20*rout.length;//内循环次数
                                    let rout2 = Sa_TSP(rout, distanceList, T0, d, Tk, L);
                                    print(rout2, distanceList);
                                    let points = printPoint(rout2, namePoints1,descriptionPoints1,orderNumber1, xCoord1, yCoord1);
                                    console.log("排好序后的点对象数组：");
                                    console.log(points);
                                    //定义排好序后的点序列
                                    let pointlist = [];
                                    for(let i = 0; i < points.length; i++){
                                        pointlist[i] = new BMap.Point(points[i].y,points[i].x);
                                    }


                                    //起点
                                    let mp1 = pointlist[0];
                                    //终点
                                    let mp2 = pointlist[pointlist.length-1];

                                    map2.clearOverlays();                        //清除地图上所有的覆盖物


                                    //创建行车路线规划实例
                                    let driving = new BMap.DrivingRoute(map2);
                                    for(let i = 0;i<pointlist.length;i++){
                                        if(i != pointlist.length-1){
                                            driving.search(pointlist[i], pointlist[i+1]);  //绘制两个点之间的路线
                                        }
                                    }

                                    //标记点信息:标记点，当前点，下一个点，当前点名称，下一点名称，点信息窗口标题，点详细信息，地图
                                    function markInfo(mark,points1,points2,pointsname1,pointsname2,pointInfoTitle,pointText,map){
                                        mark.addEventListener("click",function(e){
                                            var opts = {
                                                width: 250,  // 信息窗口宽度
                                                height: 100,  // 信息窗口高度
                                                title: pointInfoTitle, // 信息窗口标题
                                            }
                                            //创建信息窗口对象
                                            var infoWindow = new BMap.InfoWindow(pointText, opts);
                                            //对标注对象和信息窗口进行绑定
                                            map.openInfoWindow(infoWindow, points1);
                                            getduration(points1,points2,map3,pointsname1,pointsname2);

                                        });
                                    }

                                    //标记点信息:标记点，当前点，点信息窗口标题，点详细信息，地图（终点）
                                    function markInfoEnd(mark,points1,pointInfoTitle,pointText,map){
                                        mark.addEventListener("click",function(e){
                                            var opts = {
                                                width: 250,  // 信息窗口宽度
                                                height: 100,  // 信息窗口高度
                                                title: pointInfoTitle, // 信息窗口标题
                                            }
                                            //创建信息窗口对象
                                            var infoWindow = new BMap.InfoWindow(pointText, opts);
                                            //对标注对象和信息窗口进行绑定
                                            map.openInfoWindow(infoWindow, points1);
                                            G("output2").innerHTML = "终点";
                                        });
                                    }


                                    function G(id) {
                                        return document.getElementById(id);
                                    }

                                    //返回两点实际距离，时间
                                    //参数：第一点，第二点，渲染地图，第一点的名称，第二点的名称
                                    function getduration(point1, point2,map,pointname1,pointname2) {
                                        //var startdm = G("suggestId").innerHTML;
                                        //var enddm = G("suggestId2").innerHTML;
                                        var output = pointname1 + "->" + pointname2 + " ：驾车需要";
                                        var searchComplete = function (results) {
                                            if (transit.getStatus() != BMAP_STATUS_SUCCESS) {
                                                return;
                                            }
                                            var plan = results.getPlan(0);
                                            output += plan.getDuration(true) + "\n";                //获取时间
                                            output += "，路程为";
                                            output += plan.getDistance(true) + "\n";             //获取距离
                                            G("output2").innerHTML = output;
                                        }
                                        var transit = new BMap.DrivingRoute(map, {
                                            renderOptions: { map: map },
                                            onSearchComplete: searchComplete,
                                            onPolylinesSet: function () {
                                                // setTimeout(function () { alert(output) }, "1000");
                                            }
                                        });
                                        transit.search(point1, point2);
                                    }





                                    //除去起点和终点后的所有途经点
                                    for (let i = 1;i<pointlist.length-1;i++){
                                        let mark = new BMap.Marker(pointlist[i]);
                                        map2.addOverlay(mark);

                                        //pop信息标题
                                        let title1 =  '<div style="font-weight:bold;color:#CE5521;font-size:20px">' + "订单数：" + points[i].orderNum + "个" + '</div>';
                                        //pop弹窗信息
                                        let html1 =  '<div style="font-size:17px">' + points[i].name +'<br>描述：'+ points[i].description + '</div>';

                                        markInfo(mark,pointlist[i],pointlist[i+1],points[i].name,points[i+1].name,title1,html1,map2);


                                        let label = new BMap.Label(i.toString(),{position:pointlist[i]});
                                        map2.addOverlay(label);
                                    }

                                    //显示终点和起点的标注
                                    driving.setSearchCompleteCallback(function(){
                                        let pts = driving.getResults().getPlan(0).getRoute(0).getPath();
                                        //通过驾车实例，获得一系列点的数组
                                        let polyline = new BMap.Polyline(pts);
                                        map2.addOverlay(polyline);
                                        let m1 = new BMap.Marker(mp1);         //起点
                                        let m2 = new BMap.Marker(mp2);         //终点
                                        map2.addOverlay(m1);
                                        map2.addOverlay(m2);


                                        //pop信息标题
                                        let title2m1 =  '<div style="font-weight:bold;color:#CE5521;font-size:20px">' + "订单数：" + points[0].orderNum + "个" + '</div>';
                                        let title2m2 =  '<div style="font-weight:bold;color:#CE5521;font-size:20px">' + "订单数：" + points[points.length-1].orderNum + "个" + '</div>';

                                        //pop弹窗信息
                                        let html2m1 =  '<div style="font-size:17px">' + points[0].name + '<br>描述'+ points[0].description + '</div>';
                                        let html2m2 =  '<div style="font-size:17px">' + points[points.length-1].name + '<br>描述：' + points[points.length-1].description + '</div>';


                                        markInfo(m1,mp1,pointlist[1],points[0].name,points[1].name,title2m1,html2m1,map2);//起点标记
                                        markInfoEnd(m2,mp2,title2m2,html2m2,map2);//终点标记


                                        let lab1 = new BMap.Label("起点",{position:mp1});
                                        let lab2 = new BMap.Label("终点",{position:mp2});
                                        map2.addOverlay(lab1);
                                        map2.addOverlay(lab2);
                                        setTimeout(function(){
                                            map2.setViewport(pointlist);
                                            //调整到最佳视野
                                        },1000);
                                    });


                                }
                                else if(namePoints1.length === 2){
                                    let startPoint1 = [];
                                    let endPoint1 = [];
                                    startPoint1[0] = yCoord1[0];
                                    startPoint1[1] = xCoord1[0];
                                    endPoint1[0] = yCoord1[1];
                                    endPoint1[1] = xCoord1[1];
                                    let p1 = new BMap.Point(startPoint1[0],startPoint1[1]);//起点
                                    let p2 = new BMap.Point(endPoint1[0],endPoint1[1]);//终点
                                    let driving2 = new BMap.DrivingRoute(map2,
                                        {renderOptions:{map: map2, autoViewport: true}});
                                    driving2.search(p1, p2);//waypoints表示途经点
                                }
                            }
                        });
                    }
                });
            }
        });
    }

    //---------------------------------
    $().ready(function() {
        planRoute1();
        planRoute2();
    })

    function getNowFormatDate() {
        let date = new Date();
        let seperator1 = "-";
        let year = date.getFullYear();
        let month = date.getMonth() + 1;
        let strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        let currentdate = year + seperator1 + month + seperator1 + strDate;
        return currentdate;
    }

</script>

</body>
</html>